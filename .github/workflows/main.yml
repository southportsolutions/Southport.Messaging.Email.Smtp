
name: Build and Deploy

on:
  workflow_dispatch:
      inputs:
        logLevel:
          description: 'Log level'
          required: true
          default: 'warning'
          type: choice
          options:
          - info
          - warning
          - debug
        tags:
          description: 'Test scenario tags'
          required: false
          type: boolean
        environment:
          description: 'Environment to run tests against'
          type: environment
          required: true
  push:
    branches: [ main ]
    tags: [ 'release@*' ]    
  pull_request:
    branches: [ main ]

env:
  PROJECT_NAME: ${{ vars.PROJECT_NAME || 'MissingProjectName' }}
  BUILD_CONFIGURATION: ${{ vars.BUILD_CONFIGURATION || 'Release' }}
  SMTPPORT: 587
  SMTPADDRESS: 'smtp.mailgun.org'
  SMTPTESTEMAILADDRESSES: 'test1@southport.solutions'

  
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            10.0.x
            9.0.x

      - name: Resolve version
        id: version
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/release@* ]]; then
            # tag is like refs/tags/release@1.2.3
            VERSION="${GITHUB_REF#refs/tags/release@}"
          else
            VERSION="1.0.0-alpha1"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
      
      - name: Restore
        shell: bash
        run: |
          shopt -s globstar nullglob
          dotnet restore **/*.sln --configfile nuget.config

      - name: Build & Pack
        shell: bash
        run: |
          shopt -s globstar nullglob
          dotnet pack **/${{ env.PROJECT_NAME }}.csproj \
            --output "${{ github.workspace }}/artifacts" \
            --configuration "${{ env.BUILD_CONFIGURATION }}" \
            /p:Version="${{ steps.version.outputs.version }}"

      
      - name: Test (NET9) and collect coverage
        shell: bash
        env:
          SMTPUSERNAME: ${{ secrets.SMTPUSERNAME }}
          SMTPPASSWORD: ${{ secrets.SMTPPASSWORD }}
          SMTPPORT: ${{ env.SMTPPORT }}
          SMTPADDRESS: ${{ env.SMTPADDRESS }}
          SMTPTESTEMAILADDRESSES: ${{ env.SMTPTESTEMAILADDRESSES }}
          SMTPFROMADDRESS: ${{ secrets.SMTPUSERNAME }}
          
        run: |
          shopt -s globstar nullglob
          dotnet test **/${{ env.PROJECT_NAME }}.Tests.csproj \
            --framework net9.0 \
            --configuration Release \
            --collect:"XPlat Code Coverage" \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura,opencover
          # Move/rename coverage file for NET9
          find . -name 'coverage.cobertura.xml' -exec mv {} coverage.net9.cobertura.xml \;

      - name: Test (NET10) and collect coverage
        shell: bash
        env:
          SMTPUSERNAME: ${{ secrets.SMTPUSERNAME }}
          SMTPPASSWORD: ${{ secrets.SMTPPASSWORD }}
          SMTPPORT: ${{ env.SMTPPORT }}
          SMTPADDRESS: ${{ env.SMTPADDRESS }}
          SMTPTESTEMAILADDRESSES: ${{ env.SMTPTESTEMAILADDRESSES }}
          SMTPFROMADDRESS: ${{ secrets.SMTPUSERNAME }}
        run: |
          shopt -s globstar nullglob
          dotnet test **/${{ env.PROJECT_NAME }}.Tests.csproj \
            --framework net10.0 \
            --configuration Release \
            --collect:"XPlat Code Coverage" \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura,opencover
          # Move/rename coverage file for NET10
          find . -name 'coverage.cobertura.xml' -exec mv {} coverage.net10.cobertura.xml \;

      
      - name: Upload NET9 coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-net9
          path: coverage.net9.cobertura.xml

      - name: Upload NET10 coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-net10
          path: coverage.net10.cobertura.xml

      - name: Publish to nuget.org (only on release tags)
        if: startsWith(github.ref, 'refs/tags/release@')
        env:
          NUGET_API_KEY: ${{ secrets.NUGETPUSH }}
          SOURCE: 'https://api.nuget.org/v3/index.json'
        shell: bash
        run: |
          shopt -s globstar nullglob
          dotnet nuget push **/${{ env.PROJECT_NAME }}.${{ steps.version.outputs.version }}.nupkg --source ${SOURCE} --api-key ${NUGET_API_KEY}
